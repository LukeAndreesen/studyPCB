<!-- IMPORTANAT NOTE: THIS WAS NEARLY 100% GENERATED BY CHATGPT -->
<!-- THIS WAS A QUICK REPLACEMENT FOR MY DISPLAYS THAT DIND'T WORK -->
<!-- HOWEVER, THE APPLICATION IS PULLING AND PARSING SERIAL DATA FROM MY PCB -->


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Study Timer</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      min-height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
    }
    .container {
      background: rgba(255, 255, 255, 0.95);
      color: #2d3748;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      text-align: center;
    }
    h1 {
      margin-bottom: 10px;
    }
    .clickable-time {
      font-family: 'Courier New', monospace;
      font-size: 3em;
      margin: 20px 0;
      display: flex;
      justify-content: center;
    }
    .time-part {
      padding: 0 10px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .time-part.selected {
      background: #c3dafe;
      border: 2px solid #667eea;
    }
    .colon {
      padding: 0 5px;
    }
    .status, .dial-info, .timer-status {
      margin-top: 10px;
      font-weight: 600;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      font-size: 1em;
      cursor: pointer;
      background: #667eea;
      color: #fff;
      transition: background 0.3s;
    }
    button:hover {
      background: #5a67d8;
    }
    #message {
      margin-top: 15px;
      color: #e53e3e;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Study Timer</h1>
    <div id="status">üî¥ Disconnected</div>
    <div class="clickable-time" id="displayTime">
      <span class="time-part" id="minutesDigit" onclick="adjustTime('minutes')">0</span>
      <span class="colon">:</span>
      <span class="time-part" id="secondsTensDigit" onclick="adjustTime('secondsTens')">0</span>
      <span class="time-part" id="secondsOnesDigit" onclick="adjustTime('secondsOnes')">0</span>
    </div>
    <div class="timer-status" id="timerStatus">Ready</div>
    <div class="dial-info" id="dialInfo">üéõÔ∏è Dial Value: 0</div>
    <div style="margin-top: 15px; text-align: left">
      <div><strong>üì± Phone Detected:</strong> <span id="phoneStatus">-</span></div>
      <div><strong>üßç At Desk:</strong> <span id="deskStatus">-</span></div>
    </div>
    <div>
      <button onclick="toggleConnection()">Connect</button>
      <button onclick="startTimer()">Start</button>
      <button onclick="resetTimer()">Reset</button>
    </div>
    <div id="message"></div>
  </div>

  <script>
    let selectedTimePart = null;
    let port = null;
    let isConnected = false;
    let currentDialValue = 0;
    let totalSeconds = 0;
    let currentSeconds = 0;
    let timerInterval = null;
    let isRunning = false;
    let lastPhoneDetected = null;
    let lastAtDesk = null;
    let lastMessageTime = 0;


    function adjustTime(part) {
      if (isRunning) return;
      selectedTimePart = part;
      document.querySelectorAll('.time-part').forEach(el => el.classList.remove('selected'));
      document.getElementById(`${part}Digit`)?.classList.add('selected');
      document.getElementById('dialInfo').textContent = `üéõÔ∏è Dial Value: ${currentDialValue}`;
    }

    async function postMessage() {
    try {
        const response = await fetch('http://localhost:3000/send-message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
        });

        const result = await response.json();
        if (result.success) {
        showMessage('Message sent successfully!', 'success');
        } else {
        showMessage('Failed to send message: ' + result.error, 'error');
        }
    } catch (err) {
        showMessage('Error: ' + err.message, 'error');
    }
    }

    async function toggleConnection() {
      if (!('serial' in navigator)) {
        showMessage('Web Serial API not supported');
        return;
      }
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        isConnected = true;
        document.getElementById('status').textContent = 'üü¢ Connected';
        readFromArduino();
      } catch (err) {
        showMessage('Failed to connect: ' + err.message);
      }
    }

    async function sendToPCB(message) {
      if (isConnected && port && port.writable) {
        const writer = port.writable.getWriter();
        await writer.write(new TextEncoder().encode(message + "\n"));
        writer.releaseLock();
      }
    }

    async function sendHelloWorld() {
      try {
        const response = await fetch('http://localhost:3000/send-message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const result = await response.json();
        if (result.success) {
          showMessage('Message sent successfully!', 'success');
        } else {
          showMessage('Failed to send message: ' + result.error, 'error');
        }
      } catch (err) {
        showMessage('Error: ' + err.message, 'error');
      }
    }

    async function readFromArduino() {
      const reader = port.readable.getReader();
      let buffer = '';
      while (isConnected) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += new TextDecoder().decode(value);
        const lines = buffer.split('\n');
        buffer = lines.pop();
        for (const line of lines) parseSensorData(line.trim());
      }
      reader.releaseLock();
    }

    function parseSensorData(line) {
      const match = line.match(/Dial Value:\s*(\d+)/i);
      if (match) {
        currentDialValue = parseInt(match[1]);
        document.getElementById('dialInfo').textContent = `üéõÔ∏è Dial Value: ${currentDialValue}`;
        if (!isRunning && selectedTimePart) {
          let value = Math.min(currentDialValue, selectedTimePart === 'secondsTens' ? 5 : 9);
          document.getElementById(`${selectedTimePart}Digit`).textContent = value;
          const minutes = parseInt(document.getElementById('minutesDigit').textContent);
          const seconds = parseInt(document.getElementById('secondsTensDigit').textContent + document.getElementById('secondsOnesDigit').textContent);
          totalSeconds = currentSeconds = minutes * 60 + seconds;
        }
      }

      const phoneMatch = line.match(/Phone:\s*(True|False)/i);
      const deskMatch = line.match(/At desk:\s*(True|False)/i);

      if (phoneMatch || deskMatch) {
        const phoneDetected = phoneMatch ? phoneMatch[1].toLowerCase() === 'true' : lastPhoneDetected;
        const atDesk = deskMatch ? deskMatch[1].toLowerCase() === 'true' : lastAtDesk;

        if (phoneMatch) {
          document.getElementById('phoneStatus').textContent = phoneDetected ? 'Yes' : 'No';
          document.getElementById('phoneStatus').style.color = phoneDetected ? '#38a169' : '#c53030';
          lastPhoneDetected = phoneDetected;
        }

        if (deskMatch) {
          document.getElementById('deskStatus').textContent = atDesk ? 'Yes' : 'No';
          document.getElementById('deskStatus').style.color = atDesk ? '#3182ce' : '#c53030';
          lastAtDesk = atDesk;
        }

        if (isRunning && !phoneDetected && !atDesk) {
        const now = Date.now();
        if (now - lastMessageTime >= 5000) {
            postMessage();
            lastMessageTime = now;
        }
        }

      }
    }

   function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
        isRunning = true;
        selectedTimePart = null;
        sendToPCB("TIMER_START");

  

    timerInterval = setInterval(() => {
        if (currentSeconds <= 0) return completeTimer();
        currentSeconds--;
        updateDisplay();
    }, 1000);
        document.getElementById('timerStatus').textContent = 'Running';
    }

    function resetTimer() {
      clearInterval(timerInterval);
      isRunning = false;
      currentSeconds = totalSeconds;
      updateDisplay();
      document.getElementById('timerStatus').textContent = 'Reset';
    }

    function completeTimer() {
      clearInterval(timerInterval);
      isRunning = false;
      sendToPCB("TIMER_END");
      document.getElementById('timerStatus').textContent = 'Done';
    }

    function updateDisplay() {
      const minutes = Math.floor(currentSeconds / 60);
      const seconds = currentSeconds % 60;
      document.getElementById('minutesDigit').textContent = minutes;
      document.getElementById('secondsTensDigit').textContent = Math.floor(seconds / 10);
      document.getElementById('secondsOnesDigit').textContent = seconds % 10;
    }

    function showMessage(msg) {
      document.getElementById('message').textContent = msg;
    }
  </script>
</body>
</html>
