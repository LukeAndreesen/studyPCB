/*
NOTE: Ths was mostly generated by ChatGPT since this was simply a
fun extra to add to my project!
*/

const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');
const morgan = require('morgan');
const { BskyAgent } = require('@atproto/api');
require('dotenv').config();

const app = express();
const PORT = 3000;

// Your predefined messages
const messages = [
    "Luke is so lazy and dumb!",
    "Luke HATES being productive and is terrible too",
    "Luke is not good!"
];

app.use(cors());
app.use(bodyParser.json());
app.use(morgan('dev'));

app.post('/send-message', async (req, res) => {
    try {
        const agent = new BskyAgent({ service: 'https://bsky.social' });
        await agent.login({
            identifier: process.env.BLUESKY_HANDLE,
            password: process.env.BLUESKY_PASSWORD,
        });

        // Format timestamp and append random message
        const timestamp = new Date().toLocaleString();
        const randomMessage = messages[Math.floor(Math.random() * messages.length)];
        const message = `⏱️ ${timestamp} — ${randomMessage}`;

        const result = await agent.post({
            text: message,
            createdAt: new Date().toISOString(),
        });

        res.json({ success: true, uri: result.uri });
    } catch (err) {
        console.error(err);
        res.status(500).json({ success: false, error: err.message });
    }
});

app.listen(PORT, () => console.log(`Server running on http://localhost:${PORT}`));
